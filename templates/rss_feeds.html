<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Feeds - RegIntelligence Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet">
    <!-- Fallback Font Awesome CDN -->
    <link href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Top Bar with Authentication -->
        <div class="top-bar">
            <div class="top-bar-content">
                <div class="top-bar-left">
                    <!-- Empty for now, could add logo later -->
                </div>
                <div class="top-bar-right">
                    <!-- Authentication UI --> {% if user %} <div id="authSection"
                        class="auth-section">
                        <div class="user-menu">
                            <span id="userName" class="user-name">{{ user.full_name or
                                user.email }}</span>
                            <div class="auth-buttons">
                                <a href="/auth/profile-page" class="profile-button">
                                    <span class="icon">üë§</span> Profile </a>
                                <button id="forceLogoutButton" class="logout-button"
                                    style="background: none; border: none; color: inherit; cursor: pointer; font: inherit;">
                                    <span class="icon">‚èª</span> Logout </button>
                            </div>
                        </div>
                    </div>
                    <div id="loginSection" class="login-section" style="display: none;">
                        <a href="/auth/login" class="login-button">
                            <span class="icon">üîë</span> Login </a>
                        <a href="/auth/register" class="register-button">
                            <span class="icon">‚ûï</span> Register </a>
                    </div> {% else %} <div id="authSection" class="auth-section"
                        style="display: none;">
                        <div class="user-menu">
                            <span id="userName" class="user-name">User</span>
                            <div class="auth-buttons">
                                <a href="/auth/profile-page" class="profile-button">
                                    <span class="icon">üë§</span> Profile </a>
                                <a href="#" class="dropdown-item">
                                    <span class="icon">‚èª</span> Logout </a>
                            </div>
                        </div>
                    </div>
                    <div id="loginSection" class="login-section">
                        <a href="/auth/login" class="login-button">
                            <span class="icon">üîë</span> Login </a>
                        <a href="/auth/register" class="register-button">
                            <span class="icon">‚ûï</span> Register </a>
                    </div> {% endif %}
                </div>
            </div>
        </div>
        <!-- Slim Banner with Website Name -->
        <div class="banner">
            <div class="banner-content">
                <h1 class="banner-title"> RegIntelligence Platform </h1>
                <p class="banner-subtitle">Latest regulatory news and updates</p>
            </div>
        </div>
        <main class="main-content">
            <!-- Navigation Tabs -->
            <div class="page-navigation">
                <div class="nav-tabs">
                    <a href="/" class="nav-tab" id="warningLettersTab">
                        <span class="icon">‚ö†Ô∏è</span> Warning Letters </a>
                    <a href="/rss-feeds" class="nav-tab active" id="rssFeedsTab">
                        <span class="icon">üì∞</span> RSS Feeds </a>
                </div>
            </div>
            <!-- RSS Feeds Content -->
            <div class="rss-content">
                <div class="rss-header">
                    <h2><span class="icon">üì∞</span> RSS Feeds</h2>
                    <p>Stay updated with the latest regulatory news from multiple
                        sources</p>
                </div>
                <!-- RSS Feeds Table -->
                <div class="info-tables-container">
                    <div class="info-table-section">
                        <h3><span class="icon">üì∞</span> Latest RSS News</h3>
                        <div class="table-container">
                            <div style="margin-bottom: 15px; text-align: right;">
                                <button id="refreshRSSBtn" class="action-button"
                                    style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    <span class="icon">üîÑ</span> Refresh RSS News
                                </button>
                            </div>
                            <table class="info-table" id="recentNewsTable">
                                <thead>
                                    <tr>
                                        <th>Published Date</th>
                                        <th>Feed Source</th>
                                        <th>Article Title</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody id="recentNewsBody">
                                    <tr>
                                        <td colspan="4" class="loading-message">Loading
                                            latest RSS news...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        // Check authentication status on page load and update UI
        async function checkAuthAndUpdateUI() {
            console.log('üîç Checking authentication status...');

            try {
                const response = await fetch('/auth/me');
                console.log('üîç Auth check response status:', response.status);

                if (response.ok) {
                    const user = await response.json();
                    console.log('üîç User authenticated successfully');

                    // Check if we have valid cookies (double-check authentication)
                    const hasAuthCookie = document.cookie.includes('auth_token') ||
                        document.cookie.includes('refresh_token') ||
                        document.cookie.includes('supabase-auth-token');

                    if (!hasAuthCookie) {
                        console.log('‚ö†Ô∏è User appears authenticated but no auth cookies found - forcing logout');
                        // Force logout by clearing any remaining state
                        localStorage.clear();
                        sessionStorage.clear();
                        showUnauthenticatedUI();
                        return;
                    }

                    // Show authenticated UI
                    showAuthenticatedUI(user);
                } else {
                    console.log('üîç User not authenticated');
                    showUnauthenticatedUI();
                }
            } catch (error) {
                console.error('üîç Error checking auth status:', error);
                showUnauthenticatedUI();
            }
        }

        // Helper function to show authenticated UI
        function showAuthenticatedUI(user) {
            const authSection = document.getElementById('authSection');
            const loginSection = document.getElementById('loginSection');

            if (authSection && loginSection) {
                authSection.style.display = 'flex';
                loginSection.style.display = 'none';

                // Update user name
                const userName = document.getElementById('userName');
                if (userName) {
                    userName.textContent = user.full_name || user.email;
                }
            }
        }

        // Helper function to show unauthenticated UI
        function showUnauthenticatedUI() {
            const authSection = document.getElementById('authSection');
            const loginSection = document.getElementById('loginSection');

            if (authSection && loginSection) {
                authSection.style.display = 'none';
                loginSection.style.display = 'flex';
            }
        }

        // Function to load latest RSS news
        async function loadLatestRSSNews() {
            try {
                console.log('üîç Loading latest RSS news...');
                const response = await fetch('/api/rss-feeds/latest');

                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç RSS news loaded successfully');
                    displayRSSNews(data.articles);
                } else {
                    console.error('‚ùå Failed to load RSS news:', response.status);
                    showRSSNewsError('Failed to load RSS news');
                }
            } catch (error) {
                console.error('‚ùå Error loading RSS news:', error);
                showRSSNewsError('Network error loading RSS news');
            }
        }

        // Standardized date formatting function
        function formatDateStandard(dateString) {
            if (!dateString || dateString === 'Unknown Date' || dateString === 'N/A') return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (error) {
                return 'N/A';
            }
        }

        // Function to display RSS news in the table
        function displayRSSNews(articles) {
            const tbody = document.getElementById('recentNewsBody');

            if (!articles || articles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="no-data">No RSS news available</td>
                    </tr>
                `;
                return;
            }

            let html = '';
            articles.forEach(article => {
                const date = formatDateStandard(article.article_published_date);
                const title = article.article_title || 'No title available';
                const category = article.content_category || 'Uncategorized';

                html += `
                    <tr>
                        <td>${date}</td>
                        <td><strong>${article.article_feed_name || 'Unknown source'}</strong></td>
                        <td><strong>${title}</strong></td>
                        <td><span class="category-badge">${category}</span></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Function to show RSS news error
        function showRSSNewsError(message) {
            const tbody = document.getElementById('recentNewsBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="error-message">${message}</td>
                    </tr>
                `;
            }
        }

        // Handle force logout button
        document.addEventListener('DOMContentLoaded', () => {
            // Load data when page loads
            loadLatestRSSNews();

            // Add refresh button event listeners
            const refreshRSSBtn = document.getElementById('refreshRSSBtn');

            if (refreshRSSBtn) {
                refreshRSSBtn.addEventListener('click', loadLatestRSSNews);
            }

            const forceLogoutButton = document.getElementById('forceLogoutButton');
            if (forceLogoutButton) {
                forceLogoutButton.addEventListener('click', async () => {
                    console.log('üîê Force logout button clicked');

                    try {
                        // First try the normal logout
                        const response = await fetch('/auth/signout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('üîê Logout response received');
                    } catch (error) {
                        console.log('üîê Logout request failed, continuing with force logout');
                    }

                    // Force clear everything regardless of backend response
                    console.log('üîê Force clearing all authentication data...');
                    localStorage.clear();
                    sessionStorage.clear();

                    // Clear all cookies aggressively
                    document.cookie.split(";").forEach(function (c) {
                        const cookieName = c.replace(/^ +/, "").split("=")[0];
                        console.log('üç™ Force clearing cookie:', cookieName);
                        document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                        document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
                        document.cookie = cookieName + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=." + window.location.hostname;
                    });

                    // Force refresh the page
                    console.log('üîÑ Force refreshing page...');
                    window.location.reload(true);
                });
            }
        });

        // Check auth on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthAndUpdateUI();
        });

        // Add CSS for navigation and table styling
        const style = document.createElement('style');
        style.textContent = `
            /* Navigation Tabs */
            .page-navigation {
                background: #f8f9fa;
                border-bottom: 1px solid #e1e5e9;
                padding: 0;
                margin-bottom: 20px;
            }
            
            .nav-tabs {
                display: flex;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 24px;
            }
            
            .nav-tab {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 16px 24px;
                text-decoration: none;
                color: #6c757d;
                font-weight: 400;
                border-bottom: 3px solid transparent;
                transition: all 0.3s ease;
                background: none;
                border: none;
                cursor: pointer;
                font-size: 16px;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .nav-tab:hover {
                color: #667eea;
                background: rgba(102, 126, 234, 0.05);
            }
            
            .nav-tab.active {
                color: #667eea;
                border-bottom-color: #667eea;
                background: rgba(102, 126, 234, 0.1);
            }
            
            .nav-tab i {
                font-size: 18px;
            }
            
            /* RSS Content */
            .rss-content {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 24px;
            }
            
            .rss-header {
                text-align: center;
                margin-bottom: 40px;
            }
            
            .rss-header h2 {
                font-size: 1.8rem;
                font-weight: 500;
                margin-bottom: 8px;
                color: #1d1d1f;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 12px;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
                letter-spacing: -0.01em;
            }
            
            .rss-header p {
                color: #6c757d;
                font-size: 1rem;
                font-weight: 300;
                margin: 0;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif !important;
            }
            
            .info-table td {
                padding: 12px;
                border-bottom: 1px solid #e1e5e9;
                vertical-align: top;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .info-table td:nth-child(1) {
                width: 120px;
                font-weight: 600;
                color: #667eea;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .info-table td:nth-child(2) {
                width: 150px;
                font-weight: 600;
                color: #333;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .info-table td:nth-child(3) {
                width: 400px;
                font-weight: 600;
                color: #333;
                line-height: 1.4;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .info-table td:nth-child(4) {
                color: #333;
                line-height: 1.5;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .category-badge {
                background: #667eea;
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .loading-message {
                text-align: center;
                color: #666;
                font-style: italic;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .no-data {
                text-align: center;
                color: #999;
                font-style: italic;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
            
            .error-message {
                text-align: center;
                color: #ff4757;
                font-style: italic;
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>